#!/bin/bash

# Êô∫ËÉΩËá™Âä®ÊøÄÊ¥ªÂáΩÊï∞
uvm_auto_activate() {
    local uvm_envs_dir="${UVM_ENVS_DIR:-${HOME}/uv_envs}"
    
    # ‰ºòÂÖàÁ∫ß 1: Ê£ÄÊü•È°πÁõÆÊú¨Âú∞ .venvÔºàÂêë‰∏äÊü•ÊâæÂà∞Ê†πÁõÆÂΩïÔºâ
    local current_dir="$PWD"
    while [ "$current_dir" != "/" ] && [ "$current_dir" != "" ]; do
        if [ -d "$current_dir/.venv" ]; then
            local activate_script=""
            if [ -f "$current_dir/.venv/bin/activate" ]; then
                activate_script="$current_dir/.venv/bin/activate"
            elif [ -f "$current_dir/.venv/Scripts/activate" ]; then
                # Windows Git Bash
                activate_script="$current_dir/.venv/Scripts/activate"
            fi
            
            if [ -n "$activate_script" ]; then
                # Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊøÄÊ¥ª‰∫ÜËøô‰∏™ÁéØÂ¢É
                if [ "$VIRTUAL_ENV" != "$current_dir/.venv" ]; then
                    # Â¶ÇÊûúÊúâÂÖ∂‰ªñÁéØÂ¢ÉÊøÄÊ¥ªÔºåÂÖàÂÅúÁî®
                    if [ -n "$VIRTUAL_ENV" ] && command -v deactivate &> /dev/null; then
                        deactivate 2>/dev/null || true
                    fi
                    
                    echo "üîÑ Auto-activating local .venv"
                    source "$activate_script"
                    export UVM_AUTO_ACTIVATED="local"
                    export UVM_AUTO_ACTIVATED_PATH="$current_dir/.venv"
                fi
                return 0
            fi
        fi
        
        # Âêë‰∏ä‰∏ÄÁ∫ßÁõÆÂΩï
        current_dir=$(dirname "$current_dir")
    done
    
    # ‰ºòÂÖàÁ∫ß 2: Ê£ÄÊü• .uvmrcÔºàÂÖ±‰∫´ÁéØÂ¢ÉÔºâ
    if [ -f ".uvmrc" ]; then
        local env_name=$(cat .uvmrc | tr -d '[:space:]' | head -n 1)
        
        if [ -n "$env_name" ]; then
            local env_path="$uvm_envs_dir/$env_name"
            
            # Ê£ÄÊü•ÁéØÂ¢ÉÊòØÂê¶Â≠òÂú®
            local activate_script=""
            if [ -d "$env_path" ]; then
                if [ -f "$env_path/bin/activate" ]; then
                    activate_script="$env_path/bin/activate"
                elif [ -f "$env_path/Scripts/activate" ]; then
                    activate_script="$env_path/Scripts/activate"
                fi
            fi
            
            if [ -n "$activate_script" ]; then
                # Ê£ÄÊü•ÊòØÂê¶Â∑≤ÁªèÊøÄÊ¥ª‰∫ÜËøô‰∏™ÁéØÂ¢É
                if [ "$VIRTUAL_ENV" != "$env_path" ]; then
                    # Â¶ÇÊûúÊúâÂÖ∂‰ªñÁéØÂ¢ÉÊøÄÊ¥ªÔºåÂÖàÂÅúÁî®
                    if [ -n "$VIRTUAL_ENV" ] && command -v deactivate &> /dev/null; then
                        deactivate 2>/dev/null || true
                    fi
                    
                    echo "üîÑ Auto-activating uvm environment: $env_name"
                    source "$activate_script"
                    export UVM_AUTO_ACTIVATED="uvm:$env_name"
                    export UVM_AUTO_ACTIVATED_PATH="$env_path"
                fi
                return 0
            else
                echo "‚ö†Ô∏è  Environment '$env_name' specified in .uvmrc not found"
                echo "   Run 'uvm create $env_name' to create it"
            fi
        fi
    fi
    
    # Â¶ÇÊûúÈÉΩ‰∏çÊª°Ë∂≥Ôºå‰∏î‰πãÂâçÊúâËá™Âä®ÊøÄÊ¥ªÁöÑÁéØÂ¢ÉÔºåÂàôÂÅúÁî®
    if [ -n "$UVM_AUTO_ACTIVATED" ] && [ -n "$VIRTUAL_ENV" ]; then
        # Ê£ÄÊü•ÊòØÂê¶Á¶ªÂºÄ‰∫ÜÊøÄÊ¥ªÁéØÂ¢ÉÁöÑÁõÆÂΩï
        local should_deactivate=true
        
        # Â¶ÇÊûúÊòØÊú¨Âú∞ .venvÔºåÊ£ÄÊü•ÊòØÂê¶ËøòÂú®È°πÁõÆÁõÆÂΩïÂÜÖ
        if [ "$UVM_AUTO_ACTIVATED" = "local" ] && [ -n "$UVM_AUTO_ACTIVATED_PATH" ]; then
            local venv_project_dir=$(dirname "$UVM_AUTO_ACTIVATED_PATH")
            # Ê£ÄÊü•ÂΩìÂâçË∑ØÂæÑÊòØÂê¶Âú®È°πÁõÆÁõÆÂΩï‰∏ã
            case "$PWD" in
                "$venv_project_dir"*)
                    should_deactivate=false
                    ;;
            esac
        fi
        
        # Â¶ÇÊûúÊòØ .uvmrc ÁéØÂ¢ÉÔºåÊ£ÄÊü•ÂΩìÂâçÁõÆÂΩïÊòØÂê¶ËøòÊúâ .uvmrc
        if [[ "$UVM_AUTO_ACTIVATED" == uvm:* ]] && [ -f ".uvmrc" ]; then
            should_deactivate=false
        fi
        
        if [ "$should_deactivate" = true ]; then
            echo "üîª Deactivating environment (left project directory)"
            if command -v deactivate &> /dev/null; then
                deactivate 2>/dev/null || true
            fi
            unset UVM_AUTO_ACTIVATED
            unset UVM_AUTO_ACTIVATED_PATH
        fi
    fi
}

# ÁîüÊàê Shell Èí©Â≠ê‰ª£Á†Å
uvm_generate_shell_hook() {
    cat <<'EOF'
# UVM Shell Hook - Auto-activation support
# Generated by uvm shell-hook

# Load UVM configuration
export UVM_HOME="${UVM_HOME:-${HOME}/.config/uvm}"
if [ -f "${UVM_HOME}/config" ]; then
    source "${UVM_HOME}/config"
fi

# Set default environment directory
export UVM_ENVS_DIR="${UVM_ENVS_DIR:-${HOME}/uv_envs}"

# Auto-activation function
uvm_auto_activate() {
    local uvm_envs_dir="${UVM_ENVS_DIR:-${HOME}/uv_envs}"
    
    # Priority 1: Check for local .venv
    local current_dir="$PWD"
    while [ "$current_dir" != "/" ] && [ "$current_dir" != "" ]; do
        if [ -d "$current_dir/.venv" ]; then
            local activate_script=""
            if [ -f "$current_dir/.venv/bin/activate" ]; then
                activate_script="$current_dir/.venv/bin/activate"
            elif [ -f "$current_dir/.venv/Scripts/activate" ]; then
                activate_script="$current_dir/.venv/Scripts/activate"
            fi
            
            if [ -n "$activate_script" ]; then
                if [ "$VIRTUAL_ENV" != "$current_dir/.venv" ]; then
                    if [ -n "$VIRTUAL_ENV" ] && command -v deactivate &> /dev/null; then
                        deactivate 2>/dev/null || true
                    fi
                    source "$activate_script"
                    export UVM_AUTO_ACTIVATED="local"
                    export UVM_AUTO_ACTIVATED_PATH="$current_dir/.venv"
                fi
                return 0
            fi
        fi
        current_dir=$(dirname "$current_dir")
    done
    
    # Priority 2: Check for .uvmrc
    if [ -f ".uvmrc" ]; then
        local env_name=$(cat .uvmrc | tr -d '[:space:]' | head -n 1)
        
        if [ -n "$env_name" ]; then
            local env_path="$uvm_envs_dir/$env_name"
            local activate_script=""
            
            if [ -d "$env_path" ]; then
                if [ -f "$env_path/bin/activate" ]; then
                    activate_script="$env_path/bin/activate"
                elif [ -f "$env_path/Scripts/activate" ]; then
                    activate_script="$env_path/Scripts/activate"
                fi
            fi
            
            if [ -n "$activate_script" ]; then
                if [ "$VIRTUAL_ENV" != "$env_path" ]; then
                    if [ -n "$VIRTUAL_ENV" ] && command -v deactivate &> /dev/null; then
                        deactivate 2>/dev/null || true
                    fi
                    source "$activate_script"
                    export UVM_AUTO_ACTIVATED="uvm:$env_name"
                    export UVM_AUTO_ACTIVATED_PATH="$env_path"
                fi
                return 0
            fi
        fi
    fi
    
    # Deactivate if left project directory
    if [ -n "$UVM_AUTO_ACTIVATED" ] && [ -n "$VIRTUAL_ENV" ]; then
        local should_deactivate=true
        
        if [ "$UVM_AUTO_ACTIVATED" = "local" ] && [ -n "$UVM_AUTO_ACTIVATED_PATH" ]; then
            local venv_project_dir=$(dirname "$UVM_AUTO_ACTIVATED_PATH")
            case "$PWD" in
                "$venv_project_dir"*)
                    should_deactivate=false
                    ;;
            esac
        fi
        
        if [[ "$UVM_AUTO_ACTIVATED" == uvm:* ]] && [ -f ".uvmrc" ]; then
            should_deactivate=false
        fi
        
        if [ "$should_deactivate" = true ]; then
            if command -v deactivate &> /dev/null; then
                deactivate 2>/dev/null || true
            fi
            unset UVM_AUTO_ACTIVATED
            unset UVM_AUTO_ACTIVATED_PATH
        fi
    fi
}

# Hook into cd command
_uvm_original_cd=$(declare -f cd | tail -n +2)
cd() {
    builtin cd "$@"
    local ret=$?
    uvm_auto_activate
    return $ret
}

# Also check on shell initialization
uvm_auto_activate

# Helper function to get environment path
_uvm_get_env_path() {
    local env_name="$1"
    local uvm_envs_dir="${UVM_ENVS_DIR:-${HOME}/uv_envs}"
    local uvm_envs_file="${HOME}/.config/uvm/envs.json"
    
    # Try default path first
    local default_path="${uvm_envs_dir}/${env_name}"
    if [ -d "${default_path}" ]; then
        echo "${default_path}"
        return 0
    fi
    
    # Try to find in envs.json
    if [ -f "${uvm_envs_file}" ]; then
        local path=$(grep -o "\"name\":\"${env_name}\"[^}]*\"path\":\"[^\"]*\"" "${uvm_envs_file}" | grep -o "\"path\":\"[^\"]*\"" | cut -d'"' -f4)
        if [ -n "$path" ] && [ -d "$path" ]; then
            echo "$path"
            return 0
        fi
    fi
    
    return 1
}

# Make uvm commands available as shell functions
uvm() {
    if [ "$1" = "activate" ]; then
        # Special handling for activate to work in current shell
        shift
        local env_name="$1"
        
        if [ -z "$env_name" ]; then
            echo "Error: Environment name is required"
            echo "Usage: uvm activate <env_name>"
            return 1
        fi
        
        # Get environment path
        local env_path=$(_uvm_get_env_path "$env_name")
        
        if [ -z "$env_path" ]; then
            echo "Error: Environment '$env_name' not found"
            echo "Run 'uvm list' to see available environments"
            return 1
        fi
        
        local activate_script=""
        if [ -f "$env_path/bin/activate" ]; then
            activate_script="$env_path/bin/activate"
        elif [ -f "$env_path/Scripts/activate" ]; then
            activate_script="$env_path/Scripts/activate"
        fi
        
        if [ -n "$activate_script" ]; then
            source "$activate_script"
            export UVM_ACTIVE_ENV="$env_name"
            echo "‚úì Environment '$env_name' activated"
        else
            echo "Error: Activate script not found"
            return 1
        fi
    elif [ "$1" = "deactivate" ]; then
        # Special handling for deactivate
        if [ -n "$VIRTUAL_ENV" ] && command -v deactivate &> /dev/null; then
            deactivate
            unset UVM_ACTIVE_ENV
            unset UVM_AUTO_ACTIVATED
            unset UVM_AUTO_ACTIVATED_PATH
            echo "‚úì Environment deactivated"
        else
            echo "No active environment to deactivate"
        fi
    else
        # Call the actual uvm binary for other commands
        command uvm "$@"
    fi
}
EOF
}

